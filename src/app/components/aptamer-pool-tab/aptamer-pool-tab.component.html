<mat-card class="header-card" appearance="outlined">
  <mat-card-content>
    <div class="header-grid">
      <!-- Show/Hide Primers -->
      <div class="header-column">
        <p class="header-label">To show or hide the primer regions in the table:</p>
        <mat-slide-toggle [formField]="poolForm.showPrimers" labelPosition="before">
          Show Primers
        </mat-slide-toggle>
      </div>

      <mat-divider vertical/>

      <!-- Use CPM -->
      <div class="header-column">
        <p class="header-label">Toggle between counts per million (CPM) and raw counts</p>
        <mat-radio-group class="radio-row" aria-label="Count format" [formField]="poolForm.useCPM">
          <mat-radio-button [value]="true">CPM</mat-radio-button>
          <mat-radio-button [value]="false">Raw Counts</mat-radio-button>
        </mat-radio-group>
      </div>

      <mat-divider vertical/>

      <!-- Items per Page -->
      <div class="header-column">
        <p class="header-label">Change number of items per page</p>
        <mat-form-field appearance="outline">
          <mat-label>Items per page:</mat-label>
          <input matInput type="number" [formField]="poolForm.itemsPerPage" />
        </mat-form-field>
      </div>

      <mat-divider vertical/>

      <!-- Search -->
      <div class="header-column search-column">
        <p class="header-label">Search the pool (regex supported). For IDs, check the box and use comma-separated ids.</p>
        <div class="search-row">
          <mat-form-field appearance="outline" class="search-field">
            <input matInput placeholder="Query" [formField]="poolForm.query" />
          </mat-form-field>
          <mat-checkbox [formField]="poolForm.searchIds">Search IDs</mat-checkbox>
          <button mat-button (click)="resetSearch()">Reset</button>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<!-- Center split pane: table (left) + details (right) -->
<div class="split-root">
  <div class="table-pane">
    <mat-card appearance="outlined" class="table-card">
      <app-aptamer-table
        [rows]="filteredData()"
        [selectionCycles]="experimentReport().selectionCycleResponse"
        [showPrimers]="poolForm.showPrimers().value()"
        [useCPM]="poolForm.useCPM().value()"
        [pageSize]="poolForm.itemsPerPage().value()"
        [selectedSequence]="selectedSequence()"
        (rowSelected)="onSelectRow($event)">
      </app-aptamer-table>
    </mat-card>
  </div>

  <div class="details-pane">
    <mat-accordion multi>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Cardinality Chart (Selected Items, Positive Cycles Only)</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="bppm-block">Placeholder</div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Secondary Structure (RNAfold/Fornac)</mat-panel-title>
        </mat-expansion-panel-header>
        @if (selectedSequence()) {
          @if (mfeResource.isLoading()) {
            <div class="not-available">Loading structure prediction...</div>
          } @else if (mfeResource.hasValue()) {
            <div>
              <pre class="monospace">{{ selectedSequence() }}</pre>
              <pre class="monospace">{{ mfeResource.value().structure }}</pre>
              <pre class="monospace">Binding Free Energy: {{ mfeResource.value().mfe }} kcal/mol</pre>
              <app-fornac-visualization
                [sequence]="selectedSequence()"
                [structure]="mfeResource.value().structure">
              </app-fornac-visualization>
            </div>
          } @else {
            <div class="not-available">Error</div>
          }
        } @else {
          <div class="not-available">Structure Prediction not available</div>
        }
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Base Pair Probability Matrix (Prediction: RNAFold4J)</mat-panel-title>
        </mat-expansion-panel-header>
        <div echarts [options]="basePairProbabilityMatrixHeatmapChartOptions()" class="chart-container" [autoResize]="true"></div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Structural Context Distribution</mat-panel-title>
        </mat-expansion-panel-header>
        @if (selectedSequence()) {
          <div
            echarts
            [options]="contextProbabilitySequenceLogoChartOptions()"
            class="chart-container"
            [autoResize]="true"
            aria-label="Structural context sequence logo">
          </div>
        } @else {
          <div class="not-available">Structure Prediction not available</div>
        }
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>
