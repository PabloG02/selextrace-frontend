<mat-card class="header-card" appearance="outlined">
  <mat-card-content>
    <div class="header-grid">
      <!-- Show/Hide Primers -->
      <div class="header-column">
        <p class="header-label">To show or hide the primer regions in the table:</p>
        <mat-slide-toggle [formField]="poolForm.showPrimers" labelPosition="before">
          Show Primers
        </mat-slide-toggle>
      </div>

      <mat-divider vertical/>

      <!-- Use CPM -->
      <div class="header-column">
        <p class="header-label">Toggle between counts per million (CPM) and raw counts</p>
        <mat-radio-group class="radio-row" aria-label="Count format" [formField]="poolForm.useCPM">
          <mat-radio-button [value]="true">CPM</mat-radio-button>
          <mat-radio-button [value]="false">Raw Counts</mat-radio-button>
        </mat-radio-group>
      </div>

      <mat-divider vertical/>

      <!-- Items per Page -->
      <div class="header-column">
        <p class="header-label">Change number of items per page</p>
        <mat-form-field appearance="outline">
          <mat-label>Items per page:</mat-label>
          <input matInput type="number" [formField]="poolForm.itemsPerPage" />
        </mat-form-field>
      </div>

      <mat-divider vertical/>

      <!-- Sorting -->
      <div class="header-column">
        <p class="header-label">Modify sorting and reference cycle</p>
        <div class="sort-row">
          <label>Sort by</label>
          <mat-form-field appearance="outline">
            <mat-select [formField]="poolForm.sortBy">
              <mat-option value="enrichment">Enrichment</mat-option>
              <mat-option value="count">Count</mat-option>
              <mat-option value="unique">Unique fraction</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- TODO -->
          <label>on cycle</label>
          <mat-form-field appearance="outline" class="on-cycle-select">
            <mat-select [formField]="poolForm.onCycle">
              <mat-option [value]="null">(current)</mat-option>
              <mat-option value="1">1</mat-option>
              <mat-option value="2">2</mat-option>
              <mat-option value="3">3</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <mat-divider vertical/>

      <!-- Search -->
      <div class="header-column search-column">
        <p class="header-label">Search the pool (regex supported). For IDs, check the box and use comma-separated ids.</p>
        <div class="search-row">
          <mat-form-field appearance="outline" class="search-field">
            <input matInput placeholder="Query" [formField]="poolForm.query" />
          </mat-form-field>
          <mat-checkbox [formField]="poolForm.searchIds">Search IDs</mat-checkbox>
          <button mat-button (click)="resetSearch()">Reset</button>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<!-- Center split pane: table (left) + details (right) -->
<div class="split-root">
  <div class="table-pane">
    <mat-card appearance="outlined" class="table-card">
      <table mat-table
             [dataSource]="paginatedData()"
             class="aptamer-table"
             matSort
             [matSortActive]="sortState().active"
             [matSortDirection]="sortState().direction"
             (matSortChange)="onSortChange($event)">

        <!-- ID Column -->
        <ng-container matColumnDef="id">
         <th mat-header-cell *matHeaderCellDef mat-sort-header [attr.rowspan]="2">ID</th>
         <td mat-cell *matCellDef="let row">{{ row.id }}</td>
        </ng-container>

        <!-- Sequence Column -->
        <ng-container matColumnDef="sequence">
         <th mat-header-cell *matHeaderCellDef mat-sort-header [attr.rowspan]="2">Randomized Region</th>
         <td mat-cell *matCellDef="let row" class="sequence monospace">
           @if (poolForm.showPrimers().value()) {
             <span class="primer">{{ row.sequence! | slice: 0 : row.bounds.startIndex }}</span>
           }
           @for (base of row.sequence! | slice: row.bounds.startIndex : row.bounds.endIndex; track $index) {
             <span [class.nuc-a]="base === 'A'"
                   [class.nuc-t]="base === 'T'"
                   [class.nuc-c]="base === 'C'"
                   [class.nuc-g]="base === 'G'">{{ base }}</span>
           }
           @if (poolForm.showPrimers().value()) {
             <span class="primer">{{ row.sequence! | slice: row.bounds.endIndex }}</span>
           }
         </td>
        </ng-container>

        @for (cycle of experimentReport().selectionCycleResponse; track cycle.name) {
          @let cyclePrefix = `cycle-${cycle.round}`;
          <ng-container matColumnDef="{{ cyclePrefix }}-group">
            <th mat-header-cell *matHeaderCellDef [attr.colspan]="2">
              Round nÂº {{ cycle.round }}, {{ cycle.name }}
            </th>
          </ng-container>

          <!-- Count Column for this cycle -->
          <ng-container matColumnDef="{{ cyclePrefix }}-count">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Count</th>
            <td mat-cell *matCellDef="let row">
              {{ poolForm.useCPM().value() ? (row.cycles[cycle.round].cpm | number) : row.cycles[cycle.round].count }}
            </td>
          </ng-container>

          <!-- Frequency Column for this cycle -->
          <ng-container matColumnDef="{{ cyclePrefix }}-frequency">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Frequency</th>
            <td mat-cell *matCellDef="let row">
              {{ row.cycles[cycle.round].frequency | number: '1.1-5' }}
            </td>
          </ng-container>

          <!-- TODO: Enrichment Column for this cycle (compared to previous cycle) -->
        }

        <tr mat-header-row *matHeaderRowDef="groupedColumns(); sticky: true"></tr>
        <tr mat-header-row *matHeaderRowDef="subcolumns(); sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: dataColumns();"
            (click)="onSelectRow(row)"
            [class.selected]="selectedSequence() === row.sequence">
        </tr>
      </table>

      <mat-paginator [length]="filteredData().length"
                     [pageSize]="poolForm.itemsPerPage().value()"
                     (page)="onPageChange($event)"
                     showFirstLastButtons/>
    </mat-card>
  </div>

  <div class="details-pane">
    <mat-accordion multi>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Cardinality Chart (Selected Items, Positive Cycles Only)</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="bppm-block">Placeholder</div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Secondary Structure (RNAfold/Fornac)</mat-panel-title>
        </mat-expansion-panel-header>
        @if (selectedSequence()) {
          @if (mfeResource.isLoading()) {
            <div class="not-available">Loading structure prediction...</div>
          } @else if (mfeResource.hasValue()) {
            <div>
              <pre class="monospace">{{ selectedSequence() }}</pre>
              <pre class="monospace">{{ mfeResource.value().structure }}</pre>
              <pre class="monospace">Binding Free Energy: {{ mfeResource.value().mfe }} kcal/mol</pre>
              <app-fornac-visualization
                [sequence]="selectedSequence()"
                [structure]="mfeResource.value().structure">
              </app-fornac-visualization>
            </div>
          } @else {
            <div class="not-available">Error</div>
          }
        } @else {
          <div class="not-available">Structure Prediction not available</div>
        }
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Base Pair Probability Matrix (Prediction: RNAFold4J)</mat-panel-title>
        </mat-expansion-panel-header>
        <div echarts [options]="basePairProbabilityMatrixHeatmapChartOptions()" class="chart-container" [autoResize]="true"></div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Structural Context Distribution</mat-panel-title>
        </mat-expansion-panel-header>
        @if (selectedSequence()) {
          <div
            echarts
            [options]="contextProbabilitySequenceLogoChartOptions()"
            class="chart-container"
            [autoResize]="true"
            aria-label="Structural context sequence logo">
          </div>
        } @else {
          <div class="not-available">Structure Prediction not available</div>
        }
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>
